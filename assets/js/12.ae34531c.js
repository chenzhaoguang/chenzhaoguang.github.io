(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{475:function(s,n,e){"use strict";e.r(n);var a=e(2),r=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"前言"}},[s._v("前言")]),s._v(" "),e("p",[s._v("去年在学习docker，在看完菜鸟教程和第一本docker书后，一直想实战用一下这个技术，多用用才能熟能生巧，真正体验它的利弊。正好傅老板用docker搭完了wordpress，我也就手痒跟着搭建了一下（也就是现在的这个博客网站）。\n此处记录一下搭建过程。")]),s._v(" "),e("h2",{attrs:{id:"搭建环境"}},[s._v("搭建环境")]),s._v(" "),e("ul",[e("li",[s._v("阿里云ECS")])]),s._v(" "),e("blockquote",[e("p",[s._v("去年双11买的，720/3年，1核1G1M香港服务器，centos 7.4\n有个小插曲，阿里云的工作人员还给我打电话，问我用的怎么样。。阿里云什么时候有这种回访了。。。")])]),s._v(" "),e("ul",[e("li",[s._v("域名")])]),s._v(" "),e("blockquote",[e("p",[s._v("阿里云购买即可，像我申请的 .top 域名更是便宜，丧心病狂只要2块钱。。")])]),s._v(" "),e("ul",[e("li",[s._v("ssl证书")])]),s._v(" "),e("blockquote",[e("p",[s._v("https用的证书，我是在腾讯云免费申请的，地址为："),e("a",{attrs:{href:"https://console.cloud.tencent.com/ssl",target:"_blank",rel:"noopener noreferrer"}},[s._v("腾讯云证书管理"),e("OutboundLink")],1),s._v("，此处就不详细描述申请过程了，很简单的")])]),s._v(" "),e("ul",[e("li",[s._v("Docker")])]),s._v(" "),e("blockquote",[e("p",[s._v("这里要注意，centos中不要直接使用yum install docker，yum中的是旧的docker版本，升级参考我的这篇博文："),e("a",{attrs:{href:"https://www.keepjs.com/2017/12/29/centos-upgrade-docker/",target:"_blank",rel:"noopener noreferrer"}},[s._v("CentOS更新Docker至最新版本"),e("OutboundLink")],1)])]),s._v(" "),e("ul",[e("li",[s._v("Docker Compose")])]),s._v(" "),e("blockquote",[e("p",[s._v("compose原本是一个第三方公司写的，用来在docker中定义和运行复杂应用的小工具，后来被docker收购了，正式用来替代最早的fig。\n通过以下命令安装：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载compose")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -L https://github.com/docker/compose/releases/download/1.18.0/docker-compose-"),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("uname")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -s"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("-"),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("uname")]),s._v(" -m"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" -o /usr/bin/docker-compose\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 赋予可执行权限，确保compose可执行")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x /usr/bin/docker-compose\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])])]),s._v(" "),e("h2",{attrs:{id:"添加一个docker-network"}},[s._v("添加一个docker network")]),s._v(" "),e("p",[s._v("网站需要占据80端口，显然，我们的服务器不可能只有一个网站，所以部署一个nginx容器是必须的，让这个nginx来监听80以及443端口，再根据域名转发到对应的网站容器。容器之间的通信是通过network的，所以我们需要先添加一个network：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v(" docker network create nginx-proxy\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"compose部署wordpress和mysql容器"}},[s._v("compose部署WordPress和MySql容器")]),s._v(" "),e("ul",[e("li",[s._v("创建工作目录，创建docker-compose.yml文件：")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" myblog "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" myblog\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" docker-compose.yml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[s._v("docker-compose.yml输入以下内容：")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('version: \'3\'\nservices:\n   db:\n     image: mysql:5.7\n     volumes:\n       - db_data:/var/lib/mysql\n     restart: always\n     environment:\n       MYSQL_ROOT_PASSWORD: your-mysql-root-password    # 在这里输入你要设置的mysql密码\n       MYSQL_DATABASE: wordpress\n       MYSQL_USER: wordpress\n       MYSQL_PASSWORD: wordpress\n   wordpress:\n     depends_on:\n       - db\n     image: wordpress:latest\n     volumes:\n        - wp_site:/var/www/html     # 定义卷后，compose down之类的操作不会导致你的文章等数据丢失\n     expose:\n       - 80\n     restart: always\n     environment:\n       VIRTUAL_HOST: www.keepjs.com,keepjs.com\n       WORDPRESS_DB_HOST: db:3306\n       WORDPRESS_DB_USER: wordpress\n       WORDPRESS_DB_PASSWORD: wordpress\n   nginx-proxy:\n     image: jwilder/nginx-proxy\n     container_name: nginx-proxy\n     restart: always\n     ports:\n       - "80:80"\n       - "443:443"\n     volumes:\n       - /var/run/docker.sock:/tmp/docker.sock:ro   # docker.sock是docker守护进程默认监听的Unix域套接字，容器进程通过它与守护进程进行通信。以后添加新的站点时，nginx将会自动发现并重启服务\n       - nginx_certs:/etc/nginx/certs:ro    # nginx的证书目录，:ro指定为只读\nvolumes:\n    db_data:\n    wp_site:\n    nginx_certs:\nnetworks:\n   default:\n     external:\n       name: nginx-proxy\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br")])]),e("h2",{attrs:{id:"添加ssl证书"}},[s._v("添加ssl证书")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出所有的卷信息，查找到xxx_wp_certs(xxx是docker自动添加的)")]),s._v("\ndocker volume "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询出xxx_wp_certs的真实路径，一般是在 /var/lib/docker/volumes/xxx_wp_certs/_data")]),s._v("\ndocker volume inspect --format "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{{ .Mountpoint }}'")]),s._v(" xxx_wp_certs\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建www.keepjs.com.key，并且把ssl证书的xxx.key内容复制粘贴进来")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /var/lib/docker/volumes/xxx_wp_certs/_data "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" www.keepjs.com.key\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建www.keepjs.com.crt，并且把ssl证书的xxx.crt内容复制粘贴进来")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /var/lib/docker/volumes/xxx_wp_certs/_data "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" www.keepjs.com.crt\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("nginx-proxy如果发现在certs文件夹中存在当前域名的.crt和.key文件，将自动转为https协议")]),s._v(" "),e("h2",{attrs:{id:"运行wordpress"}},[s._v("运行wordpress")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker-compose up -d\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("此时，我们的网站就可以访问了，很简单吧？")]),s._v(" "),e("p",[s._v("参考资料：\n"),e("a",{attrs:{href:"https://www.fujiabin.com/2017/11/07/deploy-wordpress-with-docker-compose-in-centos7/",target:"_blank",rel:"noopener noreferrer"}},[s._v("傅老板的博客"),e("OutboundLink")],1),s._v(" "),e("a",{attrs:{href:"https://github.com/docker/compose",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker-compose"),e("OutboundLink")],1),s._v(" "),e("a",{attrs:{href:"https://hub.docker.com/r/jwilder/nginx-proxy/",target:"_blank",rel:"noopener noreferrer"}},[s._v("nginx-proxy"),e("OutboundLink")],1)])])}),[],!1,null,null,null);n.default=r.exports}}]);